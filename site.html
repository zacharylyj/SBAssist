<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBAssist</title>

    <style>
        body {
            font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Helvetica, Apple Color Emoji, Arial, sans-serif, Segoe UI Emoji, Segoe UI Symbol;
        }

        .logo-container {
            position: absolute;
            top: 0;
            left: 0;
            height: 80px;
            width: auto
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: calc(100vh - 90px);
            /* minus till no scroll if logo increase decrease this*/
            margin: calc(50px + 30px) 0 0 0;
            gap: 5px;
        }

        .chat-user {
            background-color: #d1c9ffb3;
            border-radius: 1rem;
            text-align: left;
            max-width: 70%;
            width: auto;
            min-width: 20px;
            margin-left: auto;
            margin-right: 10px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
            display: inline-block;
            word-wrap: break-word;
            white-space: pre-wrap;
            box-sizing: border-box;
        }

        .chat-assistant {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .chat-assistant img.assistant-logo {
            width: 28px;
            height: 28px;
            margin-right: 10px;
            margin-top: 8px;
            border-radius: 50%;
            /* This makes the image a circle */
            object-fit: cover;
            /* Ensures the image scales properly within the circle */
        }

        .chat-assistant .assistant-message {
            flex: 1;
            text-align: left;
            max-width: 100%;
        }

        .chat-container {
            flex: 1;
            /* Takes up the remaining space */
            width: 100%;
            max-width: 920px;
            min-width: 460px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 5px;

        }

        .chat-message {
            display: flex;
            flex-direction: column;
        }

        .input-container {
            width: 100%;
            max-width: 620px;
            min-width: 460px;
            margin: 0 30px;
            padding: 10px;
            border-radius: 1.5em;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
            height: auto;
        }

        @keyframes slideDown {
            0% {
                transform: translate(calc(-50% - 30px), -50%);
            }

            100% {
                transform: translate(calc(-50% - 30px), 38vh);
            }
        }

        .input-container.animate {
            animation: slideDown 0.5s forwards;
        }

        /* Initial centered style for input-container */
        .input-container.centered {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(calc(-50% - 30px), -50%);
            transition: top 0.5s ease, transform 0.5s ease;
        }


        /* Add a keyframe animation for the welcome message */
        @keyframes fadeSlideUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-30px);
            }
        }

        .welcome-message {
            text-align: center;
            width: 600px;
            /* Set the desired width */
            line-height: 1.5;
            /* Optional: set line height for better readability */
            word-wrap: break-word;

        }

        /* Apply the animation */
        .welcome-message.fade-out {
            animation: fadeSlideUp 0.5s forwards;
        }

        .input-bar {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 10px;
            position: relative;
        }

        .input-bar .box {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-input-button {
            border: none;
            background-color: transparent;
            cursor: pointer;
            position: relative;
        }

        .file-input-button label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .file-input-button label svg {
            width: 24px;
            height: 24px;
            fill: #666;
            transition: fill 0.2s;
        }

        .file-input-button:hover label svg {
            fill: #58004F;
        }

        .file-input-button input[type="file"] {
            display: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f1f1f1;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
            max-width: 600px;
            width: 100%;
            transition: background-color 0.3s;
        }

        .file-item:hover {
            background-color: #e0e0e0;
            /* Optional: slightly change background color on hover */
        }

        .file-close {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #f44336;
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            /* Initially hidden */
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 16px;
            font-weight: bold;
            padding: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .file-item:hover .file-close {
            display: flex;
            /* Show close button on hover */
        }

        .file-close:hover {
            background-color: #d32f2f;
        }

        .file-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }

        .file-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .file-type {
            font-size: 12px;
            color: #666;
        }


        .text-input {
            flex: 1;
            font-size: 16px;
            min-height: 16px;
            max-height: 180px;
            border-radius: 4px;
            padding: 0;
            margin: auto;
            border: 1px transparent;
            resize: none;
            overflow-y: auto;
            font-feature-settings: "liga" 0;
        }

        .text-input:focus {
            outline: none;
            border: none;
        }

        .send-button {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background-color: #58004F;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .send-button:hover:not(:disabled) {
            opacity: 0.8;
        }

        .send-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            font-size: 1.5em;
            text-align: center;
            pointer-events: none;
            backdrop-filter: blur(5px);
        }

        .drag-overlay svg {
            width: 250px;
            height: 250px;
            margin-bottom: 10px;
            fill: white;
        }

        .upload-tooltip {
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            white-space: nowrap;
            display: none;
            pointer-events: none;
        }

        .file-input-button:hover .upload-tooltip {
            display: block;
        }

        .warn-text {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin: 0;
            padding: 0;
        }

        .gif-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Optional: background overlay */
            border-radius: 8px;
            padding: 20px;
        }

        .fade-in-gif {
            width: 128px;
            /* Set your desired width */
            height: auto;
            opacity: 0;
            animation: fadeIn 1s forwards;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        /* Styles for RAG Pop-up */
        .rag-popup {
            position: fixed;
            top: 0;
            left: -400px;
            /* Hidden initially */
            width: 400px;
            height: 100%;
            background-color: #f9f9f9;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
            transition: left 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: hidden;
        }

        .rag-popup.open {
            left: 0;
            /* Slide in when open */
        }

        .rag-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #813a7a;
            color: white;
        }

        .close-rag-popup {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .rag-content {
            padding: 30px;
            font-size: 14px;
            color: #333;
            white-space: pre-wrap;
            /* Preserve formatting */
            overflow-y: auto;
            height: calc(100% - 100px);
            /* Adjust as needed */
        }


        /* Universal styles for all scrollbars */
        /* Chrome, Edge, Safari */
        *::-webkit-scrollbar {
            width: 6px;
            /* Width of the scrollbar */
            height: 6px;
            /* Height for horizontal scrollbars */
        }

        *::-webkit-scrollbar-track {
            background: #f1f1f1;
            /* Background color of the scrollbar track */
            border-radius: 10px;
            /* Rounded corners on the scrollbar track */
        }

        *::-webkit-scrollbar-thumb {
            background-color: #888;
            /* Color of the scrollbar thumb */
            border-radius: 10px;
            /* Rounded corners on the scrollbar thumb */
            border: 2px solid transparent;
            /* Optionally add space around thumb for better look */
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #555;
            /* Darker color when the scrollbar is hovered */
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            /* Makes the scrollbar thinner */
            scrollbar-color: #888 #f1f1f1;
            /* Thumb color (first), track color (second) */
        }

        /* Optional: make horizontal scrollbar slightly different */
        *::-webkit-scrollbar-horizontal {
            height: 6px;
            /* Adjust height for horizontal scrollbars */
        }

        .no-select {
            user-select: none;
            /* Prevents text selection */
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
</head>

<body>
    <img class="logo-container no-select" src="./assets/lkc_logo.png" alt="LKC Medicine Logo">
    <div id="gif-container" class="gif-container" style="display: none;">
        <img src="./assets/Loading.gif" alt="Loading GIF" class="fade-in-gif">
    </div>
    <!-- Side Pop-up for RAG data -->
    <div id="rag-popup" class="rag-popup">
        <div class="rag-popup-header">
            <span>RAG Data</span>
            <button id="close-rag-popup" class="close-rag-popup">&times;</button>
        </div>
        <div id="rag-content" class="rag-content"></div>
    </div>
    <div class="container">
        <div id="welcome-message" class="welcome-message">
            <h1>Welcome to the 𝑺𝑩𝑨𝒔𝒔𝒊𝒔𝒕</h1>
            <p>Creates high-quality medical questions using realistic patient scenarios
                to assess
                clinical reasoning.
                It tailors questions to the learner's level, asks for the best answer, and includes evidence-based
                explanations for
                all options.</p>
        </div>
        <div class="chat-container">
            <div class="chat-message" id="chat-message">
                <!-- Dynamically add assistant user chat messages -->
            </div>
        </div>
        <div class="input-container centered" id="input-container">
            <div class="file-container" id="fileContainer">
                <!-- Dynamically add File uploaded -->
            </div>
            <div class="input-bar" id="input-bar">
                <div class="box">
                    <div class="file-input-button">
                        <label for="file-input">
                            <svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg"
                                xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 482.14 482.14"
                                xml:space="preserve">
                                <g>
                                    <path d="M302.599,0H108.966C80.66,0,57.652,23.025,57.652,51.315v379.509c0,28.289,23.008,51.315,51.314,51.315h264.205
                        		c28.275,0,51.316-23.026,51.316-51.315V121.449L302.599,0z M373.171,450.698H108.966c-10.969,0-19.89-8.905-19.89-19.874V51.315
                        		c0-10.953,8.921-19.858,19.89-19.858l181.875-0.189v67.218c0,19.653,15.949,35.603,35.588,35.603l65.877-0.189l0.725,296.925
                        		C393.03,441.793,384.142,450.698,373.171,450.698z" />
                                    <path
                                        d="M241.054,150.96c-49.756,0-90.102,40.347-90.102,90.109c0,49.764,40.346,90.11,90.102,90.11
                        		c49.771,0,90.117-40.347,90.117-90.11C331.171,191.307,290.825,150.96,241.054,150.96z M273.915,253.087h-20.838v20.835
                        		c0,6.636-5.373,12.017-12.023,12.017c-6.619,0-12.01-5.382-12.01-12.017v-20.835H208.21c-6.637,0-12.012-5.383-12.012-12.018
                        		c0-6.634,5.375-12.017,12.012-12.017h20.834v-20.835c0-6.636,5.391-12.018,12.01-12.018c6.65,0,12.023,5.382,12.023,12.018v20.835
                        		h20.838c6.635,0,12.008,5.383,12.008,12.017C285.923,247.704,280.55,253.087,273.915,253.087z" />
                                </g>
                            </svg>
                        </label>
                        <input type="file" id="file-input" multiple accept=".pdf,.txt,.docx,.xlsx" />
                        <div class="upload-tooltip">Upload file</div>
                    </div>
                </div>
                <textarea id="text-input" class="text-input" rows="1" placeholder="Type your message..."></textarea>
                <div class="box">
                    <button id="send-button" class="send-button" disabled>&#9658;</button>
                </div>
            </div>
        </div>
        <p class="warn-text">
            SBAssist AI can make mistakes. Check important info
        </p>
        <div id="drag-overlay" class="drag-overlay" style="display: none;">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                    text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                    clip-rule="evenodd" viewBox="64.76 84.25 193.44 170.44">
                    <path fill-rule="nonzero"
                        d="M 201.365 181.455 C 197.232 183.497 193.529 186.137 189.962 189.045 L 183.826 182.025 C 188.341 177.837 193.604 174.56 199.262 172.152 C 187.813 151.87 160.125 146.567 141.867 160.746 C 135.238 165.88 130.205 173.56 128.269 183.735 L 127.66 186.914 L 124.49 187.475 C 121.384 188.018 118.61 188.767 116.178 189.718 C 100.998 195.592 96.737 212.488 106.025 225.317 C 109.999 230.775 115.065 236.341 121.713 237.268 L 131.006 237.268 C 130.943 238.182 130.909 239.103 130.909 240.033 C 130.909 242.27 131.098 244.462 131.464 246.595 L 121.563 246.595 L 120.978 246.543 C 111.673 245.361 104.025 238.432 98.499 230.778 C 85.615 213.039 91.958 189.127 112.846 181.025 C 115.026 180.175 117.357 179.465 119.814 178.895 C 122.603 167.818 128.547 159.289 136.188 153.37 C 159.716 135.139 195.037 142.909 208.513 169.695 C 210.54 169.376 212.569 169.214 214.584 169.239 C 244.73 169.461 256.651 208.01 241.008 228.776 C 234.738 237.094 225.122 244.172 215.219 246.47 L 214.179 246.595 L 208.141 246.595 C 208.665 243.515 208.819 240.384 208.598 237.268 L 213.661 237.268 C 221.022 235.497 228.874 229.441 233.543 223.198 C 244.656 208.397 236.768 178.681 214.521 178.541 C 210.174 178.505 205.647 179.556 201.365 181.455 Z M 163.383 254.688 L 176.355 254.688 C 179.389 254.688 181.876 252.201 181.876 249.167 L 181.876 231.294 L 191.337 231.294 C 193.331 231.209 194.744 230.55 195.565 229.306 C 197.781 225.981 194.754 222.699 192.654 220.385 C 186.695 213.844 176.432 204.16 173.491 200.697 C 171.26 198.235 168.09 198.235 165.858 200.697 C 162.819 204.245 152.19 214.648 146.524 221.01 C 144.558 223.226 142.129 226.243 144.171 229.306 C 145.012 230.55 146.411 231.209 148.405 231.294 L 157.866 231.294 L 157.866 249.167 C 157.866 252.167 160.35 254.688 163.383 254.688 Z"
                        style="" />
                    <path
                        d="M 82.401 118.169 L 87.127 118.169 C 87.406 115.892 89.243 114.131 91.472 114.131 C 93.686 114.131 95.514 115.868 95.81 118.122 L 100.603 118.169 C 100.87 118.169 101.085 118.384 101.085 118.651 L 101.085 123.964 C 101.085 124.231 100.87 124.445 100.603 124.445 L 82.406 124.445 C 82.144 124.445 81.923 124.231 81.923 123.964 L 81.923 118.651 C 81.919 118.385 82.134 118.167 82.401 118.169 Z M 105.148 145.246 C 111.037 145.246 115.808 150.019 115.808 155.905 C 115.808 161.795 111.034 166.566 105.148 166.566 C 99.258 166.566 94.488 161.791 94.488 155.905 C 94.488 150.016 99.261 145.246 105.148 145.246 Z M 109.34 156.156 C 109.675 156.142 109.914 156.03 110.051 155.821 C 110.426 155.261 109.915 154.708 109.561 154.319 L 105.789 150.484 C 105.382 150.084 104.912 150.077 104.504 150.484 L 100.642 154.424 C 100.311 154.796 99.902 155.304 100.246 155.821 C 100.386 156.03 100.622 156.142 100.959 156.156 L 102.82 156.156 L 102.82 159.046 C 102.82 159.595 103.271 160.054 103.826 160.054 L 106.469 160.054 C 107.026 160.054 107.479 159.601 107.479 159.046 L 107.479 156.156 L 109.34 156.156 Z M 77.146 120.206 L 79.599 120.206 L 79.599 122.704 L 77.146 122.704 C 76.658 122.704 76.212 122.905 75.891 123.226 C 75.57 123.548 75.369 123.993 75.369 124.48 L 75.369 156.814 C 75.369 157.301 75.57 157.747 75.891 158.069 C 76.214 158.392 76.661 158.593 77.146 158.593 L 91.761 158.593 C 91.934 159.458 92.189 160.294 92.516 161.092 L 77.146 161.092 C 75.973 161.092 74.902 160.609 74.126 159.833 C 73.354 159.06 72.87 157.99 72.87 156.814 L 72.87 124.48 C 72.87 123.304 73.352 122.235 74.126 121.462 C 74.899 120.688 75.969 120.206 77.146 120.206 Z M 107.638 142.479 L 107.638 124.48 C 107.638 123.991 107.437 123.547 107.116 123.224 C 106.783 122.891 106.331 122.704 105.86 122.704 L 103.409 122.704 L 103.409 120.206 L 105.86 120.206 C 107.032 120.206 108.099 120.688 108.874 121.462 C 109.654 122.241 110.136 123.31 110.136 124.48 L 110.136 143.194 C 109.338 142.879 108.502 142.638 107.638 142.479 Z M 86.451 141.654 C 85.721 141.654 85.127 141.061 85.127 140.329 C 85.127 139.599 85.721 139.005 86.451 139.005 L 101.087 139.005 C 101.818 139.005 102.411 139.599 102.411 140.329 C 102.411 141.061 101.818 141.654 101.087 141.654 L 86.451 141.654 Z M 82.042 138.85 C 82.859 138.85 83.521 139.513 83.521 140.329 C 83.521 141.148 82.859 141.81 82.042 141.81 C 81.225 141.81 80.562 141.148 80.562 140.329 C 80.562 139.513 81.225 138.85 82.042 138.85 Z M 82.042 146.907 C 82.859 146.907 83.521 147.57 83.521 148.386 C 83.521 149.204 82.859 149.866 82.042 149.866 C 81.225 149.866 80.562 149.204 80.562 148.386 C 80.562 147.57 81.225 146.907 82.042 146.907 Z M 86.453 149.711 C 85.722 149.711 85.127 149.117 85.127 148.386 C 85.127 147.656 85.722 147.061 86.453 147.061 L 94.749 147.061 C 94.059 147.872 93.465 148.762 92.981 149.711 L 86.453 149.711 Z M 82.042 130.795 C 82.859 130.795 83.521 131.457 83.521 132.274 C 83.521 133.092 82.859 133.753 82.042 133.753 C 81.225 133.753 80.562 133.092 80.562 132.274 C 80.562 131.457 81.225 130.795 82.042 130.795 Z M 86.451 133.598 C 85.721 133.598 85.127 133.005 85.127 132.274 C 85.127 131.542 85.721 130.949 86.451 130.949 L 101.087 130.949 C 101.818 130.949 102.411 131.542 102.411 132.274 C 102.411 133.005 101.818 133.598 101.087 133.598 L 86.451 133.598 Z M 91.422 116.197 C 92.681 116.197 93.703 117.218 93.703 118.479 C 93.703 119.739 92.681 120.759 91.422 120.759 C 90.161 120.759 89.141 119.739 89.141 118.479 C 89.141 117.218 90.161 116.197 91.422 116.197 Z"
                        style="transform-box: fill-box; transform-origin: 50% 50%; fill: rgb(84, 0, 255);"
                        transform="matrix(0.930581, -0.366086, 0.366086, 0.930581, -0.000003, -0.000002)" />
                    <title>upload-files</title>
                    <path class="cls-1"
                        d="M 238.46 142.036 L 250.639 142.036 C 252.27 142.036 253.592 143.358 253.592 144.989 L 253.592 156.522 C 253.592 158.152 252.27 159.475 250.639 159.475 L 238.46 159.475 C 236.829 159.475 235.507 158.152 235.507 156.522 L 235.507 144.979 C 235.507 143.348 236.829 142.026 238.46 142.026 L 238.46 142.036 Z M 246.334 131.13 L 248.92 131.13 C 249.52 131.125 250.097 131.362 250.521 131.786 C 250.943 132.212 251.179 132.788 251.177 133.387 L 251.177 138.906 L 249.209 138.906 L 249.209 133.397 C 249.209 133.312 249.176 133.229 249.117 133.168 C 249.054 133.107 248.97 133.074 248.884 133.076 L 246.344 133.076 L 246.344 138.903 L 244.274 138.903 L 244.274 130.634 L 235.668 130.634 C 235.088 130.642 234.614 130.174 234.614 129.595 L 234.614 121.215 L 219.955 121.215 L 219.955 152.542 L 232.239 152.542 L 232.239 154.612 L 223.253 154.612 L 223.253 157.211 C 223.252 157.296 223.285 157.379 223.344 157.44 C 223.406 157.5 223.489 157.533 223.574 157.532 L 232.233 157.532 L 232.233 159.478 L 223.587 159.478 C 222.34 159.464 221.333 158.457 221.316 157.211 L 221.316 154.625 L 219.738 154.625 C 219.247 154.624 218.775 154.43 218.426 154.084 C 218.078 153.736 217.883 153.264 217.884 152.771 L 217.884 121.005 C 217.881 119.98 218.713 119.147 219.738 119.151 L 235.668 119.151 C 235.977 119.15 236.269 119.291 236.462 119.532 L 245.593 128.39 C 246.034 128.516 246.34 128.916 246.344 129.375 L 246.344 131.111 L 246.334 131.13 Z M 224.444 141.098 C 224.074 141.108 223.787 141.421 223.807 141.79 C 223.779 142.163 224.069 142.485 224.444 142.496 L 232.219 142.496 L 232.219 141.098 L 224.444 141.098 Z M 224.444 146.105 C 224.074 146.118 223.789 146.435 223.813 146.804 C 223.789 147.172 224.074 147.488 224.444 147.502 L 232.219 147.502 L 232.219 146.105 L 224.444 146.105 Z M 224.444 131.081 C 224.064 131.08 223.763 131.401 223.787 131.78 C 223.763 132.158 224.064 132.479 224.444 132.479 L 231.625 132.479 C 231.994 132.463 232.277 132.147 232.252 131.78 C 232.277 131.412 231.994 131.097 231.625 131.081 L 224.444 131.081 Z M 224.444 126.074 C 224.074 126.088 223.789 126.404 223.813 126.773 C 223.789 127.141 224.074 127.458 224.444 127.472 L 228.381 127.472 C 228.749 127.456 229.032 127.14 229.007 126.773 C 229.032 126.405 228.749 126.09 228.381 126.074 L 224.444 126.074 Z M 224.444 136.091 C 224.064 136.09 223.763 136.411 223.787 136.79 C 223.763 137.168 224.064 137.489 224.444 137.489 L 236.583 137.489 C 236.958 137.48 237.254 137.165 237.24 136.79 C 237.264 136.411 236.963 136.09 236.583 136.091 L 224.444 136.091 Z M 236.714 122.78 L 242.896 128.564 L 236.698 128.564 L 236.698 122.78 L 236.714 122.78 Z M 248.365 151.584 C 248.622 151.598 248.868 151.483 249.022 151.279 C 249.35 150.77 248.897 150.268 248.576 149.914 C 247.663 148.913 245.596 147.102 245.147 146.574 C 244.85 146.197 244.279 146.197 243.982 146.574 C 243.516 147.115 241.337 149.038 240.471 150.009 C 240.169 150.337 239.815 150.813 240.11 151.279 C 240.264 151.483 240.51 151.598 240.767 151.584 L 242.388 151.584 L 242.388 154.494 C 242.389 154.999 242.798 155.407 243.302 155.409 L 245.836 155.409 C 246.342 155.409 246.753 155 246.755 154.494 L 246.755 151.584 L 248.365 151.584 Z"
                        style="fill-rule: evenodd; transform-box: fill-box; transform-origin: 50% 50%; fill: rgb(90, 0, 255);"
                        transform="matrix(0.965926, 0.258819, -0.258819, 0.965926, 0, 0.000002)" />
                    <path fill-rule="nonzero"
                        d="M 156.572 122.498 C 155.484 122.498 155.484 120.843 156.572 120.843 L 166.076 120.843 C 166.056 121.118 166.047 121.394 166.046 121.67 C 166.046 121.949 166.056 122.225 166.076 122.498 L 156.572 122.498 Z M 173.171 86.497 L 173.171 89.188 C 173.171 95.262 174.587 95.615 179.561 95.615 L 181.599 95.615 L 173.171 86.497 Z M 181.897 97.22 L 179.911 97.22 C 174.266 97.22 171.566 96.841 171.566 89.238 L 171.566 85.857 L 153.838 85.857 C 151.832 85.857 150.187 87.502 150.187 89.509 L 150.187 114.003 L 168.86 114.003 C 168.43 114.511 168.041 115.054 167.702 115.626 L 150.187 115.626 L 150.187 123.935 C 150.187 125.936 151.838 127.587 153.838 127.587 L 167.626 127.587 C 167.952 128.151 168.324 128.688 168.737 129.191 L 153.838 129.191 C 150.953 129.191 148.582 126.821 148.582 123.935 L 148.582 89.509 C 148.582 86.616 150.946 84.252 153.838 84.252 L 172.926 84.252 C 173.177 84.252 173.414 84.371 173.566 84.572 L 183.286 95.088 C 183.489 95.306 183.503 95.519 183.503 95.783 L 183.503 111.218 C 182.986 110.941 182.45 110.702 181.897 110.505 L 181.897 97.22 Z"
                        style="fill: rgb(38, 38, 38);" />
                    <path fill="#262626" fill-rule="nonzero"
                        d="M 160.022 107.041 L 158.433 107.041 L 158.433 108.887 L 155.988 108.887 L 155.988 101.247 L 159.838 101.247 C 161.591 101.247 162.466 102.189 162.466 104.071 C 162.466 105.106 162.238 105.872 161.783 106.369 C 161.611 106.557 161.375 106.716 161.074 106.846 C 160.772 106.976 160.421 107.041 160.022 107.041 Z M 158.433 103.203 L 158.433 105.085 L 158.995 105.085 C 159.288 105.085 159.503 105.055 159.637 104.994 C 159.772 104.933 159.838 104.792 159.838 104.572 L 159.838 103.717 C 159.838 103.497 159.772 103.356 159.637 103.295 C 159.503 103.233 159.288 103.203 158.995 103.203 L 158.433 103.203 Z M 163.2 108.887 L 163.2 101.247 L 166.624 101.247 C 168.001 101.247 168.946 101.541 169.458 102.128 C 169.972 102.715 170.23 103.694 170.23 105.067 C 170.23 106.44 169.972 107.42 169.458 108.007 C 168.946 108.594 168.001 108.887 166.624 108.887 L 163.2 108.887 Z M 166.659 103.203 L 165.646 103.203 L 165.646 106.931 L 166.659 106.931 C 166.994 106.931 167.236 106.893 167.387 106.816 C 167.537 106.737 167.613 106.561 167.613 106.284 L 167.613 103.85 C 167.613 103.574 167.537 103.397 167.387 103.32 C 167.236 103.242 166.994 103.203 166.659 103.203 Z M 175.607 106.052 L 173.53 106.052 L 173.53 108.887 L 171.085 108.887 L 171.085 101.247 L 176.097 101.247 L 175.791 103.203 L 173.53 103.203 L 173.53 104.23 L 175.607 104.23 L 175.607 106.052 Z"
                        style="" />
                    <path
                        d="M 177.902 111.768 C 183.37 111.768 187.805 116.202 187.805 121.67 C 187.805 127.139 183.37 131.573 177.902 131.573 C 172.434 131.573 168 127.139 168 121.67 C 168 116.202 172.434 111.768 177.902 111.768 Z"
                        style="fill: rgb(84, 0, 255);" />
                    <path fill-rule="nonzero"
                        d="M 179.492 121.22 L 181.096 121.78 C 182.158 122.187 183.249 121.436 182.427 120.502 C 181.425 119.351 179.904 117.769 178.799 116.715 C 178.112 116.028 177.714 116.022 177.024 116.71 C 175.798 117.911 174.598 119.247 173.4 120.49 C 172.544 121.421 173.612 122.207 174.721 121.78 L 176.309 121.225 C 176.193 122.73 176.047 124.17 175.959 125.674 C 175.959 125.951 176.191 126.172 176.461 126.194 C 177.415 126.194 178.389 126.215 179.34 126.194 C 179.61 126.172 179.842 125.951 179.842 125.674 L 179.492 121.22 Z"
                        style="fill: rgb(255, 255, 255);" />
                    <text
                        style="fill: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 11.6px; font-weight: 700; white-space: pre; transform-box: fill-box; transform-origin: 43.9558% 50%;"
                        transform="matrix(0.931898, -0.36272, 0.36272, 0.931898, 57.673489, 100.855612)" x="35.677"
                        y="72.258">.txt</text>
                    <text
                        style="fill: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 10.7px; font-weight: 700; white-space: pre;"
                        x="153.486" y="139.721">.pdf</text>
                    <text
                        style="fill: rgb(51, 51, 51); font-family: Arial, sans-serif; font-size: 8.4px; font-weight: 700; white-space: pre; transform-box: fill-box; transform-origin: 50% 50%;"
                        x="157.245" y="185.187"
                        transform="matrix(0.965926, 0.258819, -0.258819, 0.965926, 58.637403, -17.701833)">.docx</text>
                </svg>
                <p>Drop .xlsx, .docx, and .txt files to be analysed</p>
            </div>
        </div>
    </div>
    <script>
        // Global Var
        const textInput = document.getElementById("text-input");
        const sendButton = document.getElementById("send-button");
        const inputBar = document.getElementById("input-bar");
        const inputContainer = document.getElementById("input-container");
        const fileInput = document.getElementById("file-input");
        const dragOverlay = document.getElementById("drag-overlay");
        const chatMessageContainer = document.querySelector('.chat-message');
        const welcomeMessage = document.getElementById("welcome-message");
        const gifContainer = document.getElementById("gif-container");

        let ws;
        let currentlyStreaming;
        let assistantMessageDiv;
        let currentMarkdown = "";
        let initialArray = [];
        let activeArray = [];
        let maxChatHistory = [];
        const maxHistoryLength = 20 // Number of assistant and user message to send back
        let reconnectInterval = 3000; // 3 seconds
        connectWebSocket();


        function updateHTML(markdown) {
            const converter = new showdown.Converter();
            const html = converter.makeHtml(markdown);

            if (assistantMessageDiv) {
                assistantMessageDiv.innerHTML = html;
            }
            scrollToBottom(); // Ensure the chat box scrolls to the latest message
        }
        function finalizeHTML(markdown) {
            const converter = new showdown.Converter();
            const finalHtml = converter.makeHtml(markdown);

            // Replace textarea content with the final version of the message
            if (assistantMessageDiv) {
                assistantMessageDiv.innerHTML = finalHtml;
            }
            scrollToBottom(); // Ensure the chat box scrolls to the latest message
        }
        function removeFrontBackticks(text) {
            // Use a regular expression to remove the starting ```markdown followed by optional spaces
            return text.replace(/^```\s*markdown\s*/, '');
        }
        function removeOuterBackticks(text) {
            // Check if the text starts with ```markdown, followed by optional spaces
            if (/^```markdown\s*/.test(text)) {
                // Remove the starting ```markdown and the ending ```
                return text.replace(/^```markdown\s*|```$/g, '');
            }
            // If the condition is not met, return the original text
            return text;
        }
        function connectWebSocket() {
            ws = new WebSocket('wss://jz92qcvyd4.execute-api.ap-southeast-1.amazonaws.com/prod/');

            ws.onopen = function () {
                console.log('WebSocket connection opened');
            };

            ws.onerror = function (error) {
                console.error('WebSocket error:', error);
            };

            ws.onclose = function () {
                console.log('WebSocket connection closed, attempting to reconnect in ' + reconnectInterval / 1000 + ' seconds...');
                setTimeout(connectWebSocket, reconnectInterval);
            };

            ws.onmessage = function (event) {
                hideGif()
                if (!assistantMessageDiv) {
                    // Create a new outer div for chat assistant
                    let chatAssistantDiv = document.createElement('div');
                    chatAssistantDiv.className = 'chat-assistant';

                    // Create the image element
                    let imgElement = document.createElement('img');
                    imgElement.src = './assets/assistant-logo.png';
                    imgElement.alt = 'Assistant Logo';
                    imgElement.className = 'assistant-logo';

                    // Append the image to the outer div
                    chatAssistantDiv.appendChild(imgElement);

                    // Create a new div for the assistant's message
                    assistantMessageDiv = document.createElement('div');
                    assistantMessageDiv.className = 'assistant-message'; // Change class name to avoid conflict

                    // Append the message div to the outer div
                    chatAssistantDiv.appendChild(assistantMessageDiv);

                    // Append the outer div to the chat container
                    chatMessageContainer.appendChild(chatAssistantDiv);
                }
                currentMarkdown += event.data; // Accumulate the streamed markdown data

                updateHTML(removeFrontBackticks(currentMarkdown.trim()));

                if (event.data.includes('𵵙')) {
                    // If the end of the message is received, finalize the rendering
                    const completeMessage = currentMarkdown.split('𵵙')[0].trim(); // Split and trim correctly
                    finalizeHTML(removeOuterBackticks(completeMessage)); // Finalize the message with markdown conversion
                    maxChatHistory.push({
                        role: 'assistant',
                        content: completeMessage
                    });
                    currentMarkdown = ""; // Clear for the next message

                    // Reset the textarea so that a new one is created for the next response
                    assistantMessageDiv = null;
                    currentlyStreaming = false;
                    sendButton.disabled = textInput.value.trim() === "";
                    ws.close()
                }
            };
        }

        function authenticate() {
            const payload = {
                user: 'LKCadmin@admin.com',
                password: 'LKCMedcine2024!'
            };
            console.log("Starting authentication...");

            return fetch('https://r6i2hvxhknzoe7shxuhnfk2i6e0mgkbh.lambda-url.ap-southeast-1.on.aws/get-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload),
            })
                .then(response => response.text())  // Returning the response as text
                .then(data => {
                    return data;  // Returning the data to the calling context
                })
                .catch(error => {
                    console.error('Error during authentication:', error);
                    throw error;  // Rethrow the error to the calling context
                });
        }
        async function callAuthentication() {
            try {
                const result = await authenticate();  // Waits for the authentication result
                console.log('Received authentication result');
                return result
                // Handle the returned result here
            } catch (error) {
                console.error('Authentication failed:', error);
            }
        }

        function scrollToBottom() {
            const chatContainer = document.querySelector('.chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hasContent(array) {
            return array.length > 0;
        }
        function replaceAndEmpty(array1, array2) {
            array2.length = 0; // Clear array2
            array2.push(...array1); // Copy elements from array1 to array2
            // Empty array1
            array1.length = 0;
        }
        function isWebSocketConnected() {
            return ws && ws.readyState === WebSocket.OPEN; // Check if WebSocket is in the 'OPEN' state
        }
        function createUserMessage(text) {
            // Create a div element to display the user's message
            const messageBubble = document.createElement('div');
            messageBubble.className = 'chat-user';

            // Append the message bubble to the chat container
            chatMessageContainer.appendChild(messageBubble);

            // Calculate total time and dynamically adjust chunk size and delay
            const totalDuration = 100; // Total time to display in milliseconds
            const textLength = text.length;

            // Calculate chunk size based on the length of the text
            let chunkSize = Math.max(Math.floor(textLength / 100), 1); // Ensure at least 1 character per chunk
            let typingDelay = totalDuration / (textLength / chunkSize);

            // Function to "stream" the message character by character
            let index = 0;
            function typeWriter() {
                if (index < text.length) {
                    // Append the next chunk of text
                    messageBubble.textContent += text.substring(index, index + chunkSize);
                    index += chunkSize; // Move index forward by chunk size
                    setTimeout(typeWriter, typingDelay); // Adjust delay dynamically
                    scrollToBottom(); // Scroll to the bottom if needed
                }
            }
            // Start the typing animation
            typeWriter();
        }
        function animateElements() {
            // Start the animations for both elements
            inputContainer.classList.add("animate");
            welcomeMessage.classList.add("fade-out");

            // Remove the welcome message after animation
            setTimeout(() => {
                welcomeMessage.remove();
            }, 500); // Match this with the animation duration
        }
        function showGif() {
            const gifContainer = document.getElementById("gif-container");
            gifContainer.style.display = "flex";
        }
        function hideGif() {
            const gifContainer = document.getElementById("gif-container");
            gifContainer.style.display = "none";
        }

        async function sendMessage() {
            sendButton.disabled = true;
            currentlyStreaming = true;
            if (inputContainer.classList.contains("centered")) {
                // Trigger the animate animation for the input-container
                inputContainer.classList.add("animate");
                welcomeMessage.classList.add("fade-out");

                // Wait for the animation to complete before moving the input-container
                setTimeout(() => {
                    // Move the input-container down
                    inputContainer.classList.remove("centered");
                    inputContainer.classList.remove("animate"); // Remove the animation class

                    // Completely remove the h1 element from the DOM after the animation
                    setTimeout(() => {
                        welcomeMessage.remove();
                    }, 500); // Match this to the CSS transition time
                }, 500); // Wait for the animation to finish (500ms)
            }
            let userMessage = "Rag Items:\n"
            const message = textInput.value.trim();
            createUserMessage(message)
            const chatHistory = maxChatHistory.slice(-maxHistoryLength + 1)
            showGif()

            if (message) {
                console.log("Message sent: ", message); // log
                textInput.value = "";
                textInput.style.height = "20px";
                if (hasContent(initialArray)) {
                    replaceAndEmpty(initialArray, activeArray);
                    renderFileItems()
                }
                for (let file of activeArray) {
                    try {
                        // Send message and file content to getRagExtract
                        const ragtext = await getRagExtract(message, file.content, file.fileName);
                        userMessage += `\nDocument: ${file.fileName}\n${ragtext}\n`

                    } catch (error) {
                        console.error(`Error while processing file: ${file.fileName}`, error);
                    }
                    userMessage += `User Query: ${message}`
                }
                if (!isWebSocketConnected()) {
                    console.log('WebSocket is not connected. Reconnecting...');
                    connectWebSocket();

                    // Wait for the WebSocket to be ready before sending the message
                    const waitForConnection = new Promise((resolve) => {
                        ws.onopen = () => {
                            console.log('WebSocket reconnected, sending message...');
                            resolve();
                        };
                    });

                    await waitForConnection; // Wait until the WebSocket reconnects
                }
                if (!hasContent(activeArray)) { userMessage = message }
                // Add in custtom message
                try {
                    sys_prompt = `
Goal:
You are SBAssist AI. 
Case-Based MCQ Generator is a specialized tool for generating case-based multiple-choice questions (MCQs) in medical and health professions education. It uses a Medical Instruct as the primary approach, offering versatility in creating contextually relevant MCQs especially for assessing clinical reasoning skills. The generator sole function is to generate high-quality MCQs for educational purposes.


Primary Function:
The generator is programmed to focus exclusively on MCQ generation based on the Medical Instruct, by considering the user's choice and the learners level. Its sole function is to generate high-quality MCQs for educational purposes, citing the appropriate reference with each question.


Medical Instruct:
You are developing a question bank for medical exams focusing on the topic of [PLEASE INSERT A TOPIC]. Please generate a high-quality single best answer multiple-choice question. Follow the principles of constructing multiple-choice items in medical education. Generate the questions using the following framework:


Case (write as a single narrative paragraph without providing each part separately):

Patient details (gender/age)

Presenting complaint

Relevant clinical history

Physical examination findings

Diagnostic test results (optional)

Question stem: [Insert relevant information from the above sections without compromising the answer]

Acceptable question style: Ask for the BEST answer NOT one that is TRUE/FALSE.

Answer options:
A. [Insert plausible answer option]

B. [Insert plausible answer option]

C. [Insert plausible answer option]

D. [Insert plausible answer option]

E. [Insert plausible answer option]

Explanation:
Identify and explain the correct answer.

Explain why this is the most appropriate answer based on evidence-based guidelines or expert consensus.

Briefly explain why the other answer options are less correct or incorrect.

Difficulty level: [PLEASE INSERT A DIFFICULTY LEVEL (E.G. EASY, DIFFICULT]

If RAG data is used cite just the RAG data.


Return the output in Markdown format.`
                    const authkey = await callAuthentication();
                    const request_llm = {
                        "action": "stream",
                        "deployment_name": "gpt4-Omni",
                        "key": authkey,
                        "sys_instruct": sys_prompt,
                        "user_request": userMessage,
                        "extended_content": [...chatHistory.slice(-maxHistoryLength + 1)]
                    };
                    console.log('Sending message to server:', message);
                    ws.send(JSON.stringify(request_llm));
                    maxChatHistory.push({
                        role: 'user',
                        content: userMessage
                    });
                    console.log(maxChatHistory);

                } catch (error) {
                    console.error("Error querying Lambda:", error); // Enhanced error logging
                    return null;
                }
            }
        }

        async function getRagExtract(query, data, filename) {
            const content = `
User Query: ${query}
Data: ${data}
`
            let dataContent = ""
            const response = await fetch('https://mmzaorzrkjnikxr7ijfrt4tdfe0sndwi.lambda-url.ap-southeast-1.on.aws/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: [{
                        role: 'user',
                        content: content
                    }],
                    azure_model_endpoint: 'gpt4-Omni'
                }),
            });

            console.log('Handshake:', response);
            if (!response.body) {
                console.error('No response body');
                return;
            }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let done = false;

            console.log('Starting to read the stream...');

            const ragPopup = document.getElementById("rag-popup");
            const ragContent = document.getElementById("rag-content");
            const ragHeader = ragPopup.querySelector(".rag-popup-header span");
            ragPopup.classList.add("open");
            ragContent.textContent = ""; // Clear previous content
            ragHeader.textContent = `Extracting from: ${filename}`;

            while (!done) {
                const {
                    value,
                    done: doneReading
                } = await reader.read();
                done = doneReading;
                let chunk = decoder.decode(value, {
                    stream: true
                });
                dataContent += chunk
                ragContent.textContent += chunk;
                ragContent.scrollTop = ragContent.scrollHeight;
            }
            setTimeout(() => {
                ragPopup.classList.remove("open");
            }, 3000); // Delay

            return dataContent
        }
        function renderFileItems() {
            console.log("Rendering Files")
            const fileContainer = document.getElementById('fileContainer');
            fileContainer.innerHTML = ''; // Clear the container before re-rendering

            initialArray.forEach((file, index) => {
                // Create the file item container
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';

                // Create the close button
                const closeButton = document.createElement('button');
                closeButton.className = 'file-close';
                closeButton.innerHTML = '&times;'; // Close icon
                closeButton.onclick = () => {
                    initialArray.splice(index, 1); // Remove the file from the array
                    renderFileItems(); // Re-render the file items
                };

                // Create the file icon
                const fileIcon = document.createElement('div');
                fileIcon.className = 'file-icon';
                fileIcon.innerHTML = `<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 104.69 122.88"
    style="enable-background:new 0 0 104.69 122.88" xml:space="preserve">
    <g>
        <path
            d="M31.54,86.95c-1.74,0-3.16-1.43-3.16-3.19c0-1.76,1.41-3.19,3.16-3.19h20.5c1.74,0,3.16,1.43,3.16,3.19 c0,1.76-1.41,3.19-3.16,3.19H31.54L31.54,86.95z M31.54,42.27c-1.74,0-3.15-1.41-3.15-3.15c0-1.74,1.41-3.15,3.15-3.15h41.61 c1.74,0,3.15,1.41,3.15,3.15c0,1.74-1.41,3.15-3.15,3.15H31.54L31.54,42.27z M66.57,108.66c-1.36-1.08-1.59-3.06-0.5-4.42 c1.08-1.36,3.06-1.59,4.42-0.5l9.57,7.59l18.21-22.27c1.1-1.35,3.09-1.54,4.43-0.44c1.35,1.1,1.54,3.09,0.44,4.43l-20.17,24.67l0,0 c-1.09,1.33-3.04,1.54-4.39,0.47L66.57,108.66L66.57,108.66z M56.85,116.58c1.74,0,3.15,1.41,3.15,3.15c0,1.74-1.41,3.15-3.15,3.15 H7.33c-2.02,0-3.85-0.82-5.18-2.15C0.82,119.4,0,117.57,0,115.55V7.33c0-2.02,0.82-3.85,2.15-5.18C3.48,0.82,5.31,0,7.33,0h90.02 c2.02,0,3.85,0.82,5.18,2.15c1.33,1.33,2.15,3.16,2.15,5.18V72.6c0,1.74-1.41,3.15-3.15,3.15c-1.74,0-3.15-1.41-3.15-3.15V7.33 c0-0.28-0.12-0.54-0.3-0.73c-0.19-0.19-0.45-0.3-0.73-0.3H7.33c-0.28,0-0.54,0.12-0.73,0.3C6.42,6.8,6.3,7.05,6.3,7.33v108.21 c0,0.28,0.12,0.54,0.3,0.73c0.19,0.19,0.45,0.3,0.73,0.3H56.85L56.85,116.58z M31.54,64.59c-1.74,0-3.15-1.41-3.15-3.15 c0-1.74,1.41-3.15,3.15-3.15h41.61c1.74,0,3.15,1.41,3.15,3.15c0,1.74-1.41,3.15-3.15,3.15H31.54L31.54,64.59z" />
    </g>
</svg>`;

                // Create the file name and type container
                const fileDetails = document.createElement('div');
                fileDetails.className = 'file-details';
                fileDetails.innerHTML = `<span class="file-name">${file.fileName}</span> <span class="file-type">(${file.fileName.split('.').pop()})</span>`;

                // Append close button, file icon, and file details to the file item
                fileItem.appendChild(closeButton);
                fileItem.appendChild(fileIcon);
                fileItem.appendChild(fileDetails);

                // Append the file item to the file container
                fileContainer.appendChild(fileItem);
            });
        }
        function handleFileUpload(files) {
            uploadFile(files);
        }

        async function uploadFile(files) {
            for (const file of files) {
                let extractedText = "";

                if (file.type === "application/pdf") {
                    const fileData = await readFileAsArrayBuffer(file);
                    extractedText = await extractTextFromPdf(fileData);
                } else if (file.type === "text/plain") {
                    extractedText = await readFileAsText(file);
                } else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
                    const fileData = await readFileAsArrayBuffer(file);
                    extractedText = await extractTextFromDocx(fileData);
                }

                if (extractedText) {
                    initialArray.push({
                        fileName: file.name,
                        content: extractedText
                    });
                    console.log("File processed: ", file.name);
                    console.log("Extracted content: ", extractedText);
                }
                renderFileItems()
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function extractTextFromPdf(arrayBuffer) {
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(" ") + "\n";
            }
            return text;
        }

        async function extractTextFromDocx(arrayBuffer) {
            const zip = await JSZip.loadAsync(arrayBuffer);
            const xml = await zip.file("word/document.xml").async("text");
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xml, "application/xml");
            const paragraphs = xmlDoc.getElementsByTagName("w:t");
            let text = "";
            for (let i = 0; i < paragraphs.length; i++) {
                text += paragraphs[i].textContent + " ";
            }
            return text;
        }

        // Drag and drop file upload
        inputContainer.addEventListener("dragover", (event) => {
            event.preventDefault();
            dragOverlay.style.display = "flex";
        });

        inputContainer.addEventListener("dragleave", () => {
            dragOverlay.style.display = "none";
        });

        inputContainer.addEventListener("drop", (event) => {
            event.preventDefault();
            dragOverlay.style.display = "none";
            if (event.dataTransfer.files.length) {
                handleFileUpload(event.dataTransfer.files);
            }
        });

        fileInput.addEventListener("change", (event) => {
            if (event.target.files.length) {
                handleFileUpload(event.target.files);
            }
        });
        // Global drop handler to hide overlay if dragging out of the window
        window.addEventListener("dragover", (event) => {
            event.preventDefault();
        });

        window.addEventListener("drop", () => {
            dragOverlay.style.display = "none";
        });
        // Toggle send button enabled state based on input
        textInput.addEventListener("input", () => {
            textInput.style.height = "20px";
            textInput.style.height = Math.min(textInput.scrollHeight, 180) + "px";
            if (!currentlyStreaming) {
                sendButton.disabled = textInput.value.trim() === "";
            }
        });

        // Add shift+enter for a new line
        textInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                if (!sendButton.disabled) {
                    sendMessage();
                }
            }
        });
        // Send button click handler
        sendButton.addEventListener("click", sendMessage);

        document.getElementById("close-rag-popup").addEventListener("click", () => {
            const ragPopup = document.getElementById("rag-popup");
            ragPopup.classList.remove("open");
        });
    </script>
</body>

</html>